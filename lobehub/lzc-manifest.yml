lzc-sdk-version: "0.1"
name: LobeHub
package: cloud.lazycat.app.lobehub
version: 2.0.0
homepage: https://lobehub.com
author: LobeHub Community
description: 开源的高性能聊天框架，支持语音合成、多模态、可扩展的插件系统

locales:
  zh:
    name: LobeHub
    description: 开源的高性能聊天框架，支持语音合成、多模态、可扩展的插件系统
  en:
    name: LobeHub
    description: An open-source, high-performance chatbot framework supporting TTS, multimodal, and extensible plugin systems

# ==================== 应用配置 ====================
application:
  subdomain: lobehub
  background_task: true
  multi_instance: false
  
  # OIDC 回调路径 - 触发懒猫系统注入 OIDC 环境变量
  # 使用 Generic OIDC 回调路径
  oidc_redirect_path: /api/auth/callback/generic-oidc
  
  # 依赖服务健康检查
  depends_on:
    - lobehub

  # HTTP 路由 - 主服务
  routes:
    - /=http://lobehub.cloud.lazycat.app.lobehub.lzcapp:3210
  
  # 高级路由 - RustFS S3 对外暴露
  # 访问地址: https://s3-lobehub.<微服域名>
  # 以及 RustFS Console 对外暴露 (s3-console)
  upstreams:
    - location: /
      domain_prefix: s3
      backend: http://rustfs.cloud.lazycat.app.lobehub.lzcapp:9000
      disable_auto_health_checking: true
    - location: /
      domain_prefix: s3-console
      backend: http://rustfs.cloud.lazycat.app.lobehub.lzcapp:9001
      disable_auto_health_checking: true

# ==================== 服务定义 ====================
services:
  # ==================== PostgreSQL 数据库 ====================
  postgresql:
    image: registry.lazycat.cloud/hexg/pgvector/pgvector:22d3d958eb148973
    environment:
      - POSTGRES_DB=lobechat
      - POSTGRES_PASSWORD=lazycat_lobehub_pg_password
    binds:
      - /lzcapp/var/postgresql:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==================== Redis 缓存 ====================
  redis:
    image: registry.lazycat.cloud/hexg/library/redis:f58bf348bfac3995
    command: redis-server --save 60 1000 --appendonly yes
    binds:
      - /lzcapp/var/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  # ==================== RustFS S3 对象存储 ====================
  rustfs:
    image: registry.lazycat.cloud/hexg/rustfs/rustfs:f2baa7a3f517608f
    environment:
      - RUSTFS_CONSOLE_ENABLE=true
      - RUSTFS_ACCESS_KEY=lzc_rustfs_admin
      - RUSTFS_SECRET_KEY=lzc_rustfs_secret_key_2024
    binds:
      - /lzcapp/var/rustfs:/data
    # 修复权限问题：rustfs 容器以非 root 用户运行，需要预先修复挂载目录权限
    setup_script: |
      #!/bin/sh
      mkdir -p /data
      chown -R rustfs:rustfs /data || chmod -R 777 /data
    command: --access-key lzc_rustfs_admin --secret-key lzc_rustfs_secret_key_2024 /data
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9000/health >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 30s

  # ==================== RustFS Bucket 初始化 ====================
  rustfs-init:
    image: registry.lazycat.cloud/hexg/minio/mc:da9f04bad33b1382
    depends_on:
      - rustfs
    entrypoint: /bin/sh
    command: |
      -c '
        set -eux;
        echo "Initializing RustFS bucket...";
        mc alias set rustfs "http://rustfs.cloud.lazycat.app.lobehub.lzcapp:9000" "lzc_rustfs_admin" "lzc_rustfs_secret_key_2024";
        mc mb "rustfs/lobe" --ignore-existing;
        mc anonymous set download "rustfs/lobe";
        echo "RustFS bucket initialized successfully";
      '

  # ==================== SearXNG 搜索引擎 ====================
  searxng:
    image: registry.lazycat.cloud/hexg/searxng/searxng:893ea2878daa50cc
    binds:
      - /lzcapp/var/searxng:/etc/searxng
    environment:
      - SEARXNG_SETTINGS_FILE=/etc/searxng/settings.yml
    # 首次启动时复制配置文件
    setup_script: |
      #!/bin/sh
      if [ ! -f /lzcapp/var/searxng/settings.yml ]; then
        mkdir -p /lzcapp/var/searxng
        cp /lzcapp/pkg/searxng-settings.yml /lzcapp/var/searxng/settings.yml
        echo "SearXNG settings initialized"
      fi
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/healthz >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # ==================== LobeHub 主服务 ====================
  lobehub:
    image: registry.lazycat.cloud/hexg/lobehub/lobehub:60121ae51c62a0e1
    depends_on:
      - postgresql
      - redis
      - rustfs
      - searxng
    environment:
      # ===== 核心配置 =====
      - APP_URL=https://lobehub.${LAZYCAT_BOX_DOMAIN}
      
      # ===== 认证配置 (使用懒猫 Generic OIDC) =====
      - AUTH_SSO_PROVIDERS=generic-oidc
      - AUTH_GENERIC_OIDC_ISSUER=${LAZYCAT_AUTH_OIDC_ISSUER_URI}
      - AUTH_GENERIC_OIDC_ID=${LAZYCAT_AUTH_OIDC_CLIENT_ID}
      - AUTH_GENERIC_OIDC_SECRET=${LAZYCAT_AUTH_OIDC_CLIENT_SECRET}
      
      # ===== 安全密钥 (建议用户后续替换) =====
      - KEY_VAULTS_SECRET=Kix2wcUONd4CX51E/ZPAd36BqM4wzJgKjPtz2sGztqQ=
      - AUTH_SECRET=NX2kaPE923dt6BL2U8e9oSre5RfoT7hg
      
      # ===== 数据库配置 =====
      - DATABASE_URL=postgresql://postgres:lazycat_lobehub_pg_password@postgresql.cloud.lazycat.app.lobehub.lzcapp:5432/lobechat
      
      # ===== S3 对象存储配置 =====
      - S3_BUCKET=lobe
      - S3_ENABLE_PATH_STYLE=1
      - S3_ACCESS_KEY=lzc_rustfs_admin
      - S3_ACCESS_KEY_ID=lzc_rustfs_admin
      - S3_SECRET_ACCESS_KEY=lzc_rustfs_secret_key_2024
      - S3_ENDPOINT=http://rustfs.cloud.lazycat.app.lobehub.lzcapp:9000
      # S3_PUBLIC_DOMAIN 使用外部可访问的 S3 二级域名 (s3-lobehub)
      - S3_PUBLIC_DOMAIN=https://s3-lobehub.${LAZYCAT_BOX_DOMAIN}
      - LLM_VISION_IMAGE_USE_BASE64=1
      - S3_SET_ACL=0
      
      # ===== 搜索配置 =====
      - SEARXNG_URL=http://searxng.cloud.lazycat.app.lobehub.lzcapp:8080
      
      # ===== Redis 配置 =====
      - REDIS_URL=redis://redis.cloud.lazycat.app.lobehub.lzcapp:6379
      - REDIS_PREFIX=lobechat
      - REDIS_TLS=0
